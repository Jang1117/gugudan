<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>êµ¬êµ¬ë‹¨ì„ ì™¸ì! ğŸ¯</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&family=Black+Han+Sans&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      min-height: 100vh;
      min-height: -webkit-fill-available;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      font-family: 'Noto Sans KR', sans-serif;
      padding: 15px;
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow-x: hidden;
    }

    .header {
      text-align: center;
      margin-bottom: 20px;
    }

    .header h1 {
      font-family: 'Black Han Sans', sans-serif;
      font-size: clamp(2rem, 7vw, 3.5rem);
      color: #fff;
      text-shadow: 0 0 30px rgba(233, 69, 96, 0.5), 0 4px 0 #e94560;
      letter-spacing: 2px;
    }

    .header p {
      color: rgba(255,255,255,0.6);
      font-size: clamp(0.85rem, 2.5vw, 1rem);
      margin-top: 8px;
    }

    .score-board {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      width: 100%;
      max-width: 400px;
      justify-content: center;
    }

    .score-item {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 12px 25px;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.2);
      flex: 1;
      max-width: 140px;
    }

    .score-item.highlight {
      background: linear-gradient(135deg, #e94560 0%, #ff6b6b 100%);
      box-shadow: 0 8px 25px rgba(233, 69, 96, 0.3);
      border: none;
    }

    .score-label {
      color: rgba(255,255,255,0.6);
      font-size: clamp(0.7rem, 2vw, 0.8rem);
    }

    .highlight .score-label {
      color: rgba(255,255,255,0.8);
    }

    .score-value {
      color: #fff;
      font-size: clamp(1.4rem, 4vw, 1.8rem);
      font-weight: bold;
    }

    .game-area {
      background: rgba(255,255,255,0.05);
      backdrop-filter: blur(20px);
      border-radius: 25px;
      padding: clamp(20px, 5vw, 35px);
      width: 100%;
      max-width: 450px;
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 15px 50px rgba(0,0,0,0.3);
    }

    .question-display {
      text-align: center;
      margin-bottom: 20px;
      display: none;
    }

    .question-display.show {
      display: block;
    }

    .question-text {
      font-size: clamp(2.5rem, 10vw, 4.5rem);
      font-weight: 900;
      color: #fff;
      text-shadow: 0 0 40px rgba(233, 69, 96, 0.3);
    }

    .message-box {
      text-align: center;
      padding: 15px;
      border-radius: 12px;
      background: rgba(255,255,255,0.05);
      margin-bottom: 15px;
      transition: all 0.3s ease;
    }

    .message-box.correct {
      background: rgba(46, 213, 115, 0.2);
    }

    .message-box.wrong {
      background: rgba(255, 71, 87, 0.2);
    }

    .message-text {
      color: #fff;
      font-size: clamp(1rem, 3.5vw, 1.3rem);
      font-weight: bold;
    }

    .message-box.correct .message-text {
      color: #2ed573;
    }

    .message-box.wrong .message-text {
      color: #ff4757;
    }

    .user-answer {
      text-align: center;
      margin-bottom: 15px;
      color: rgba(255,255,255,0.7);
      font-size: clamp(0.85rem, 2.5vw, 1rem);
      display: none;
    }

    .user-answer.show {
      display: block;
    }

    .user-answer span {
      color: #fff;
      font-weight: bold;
    }

    /* ë§ˆì´í¬ ì»¨í…Œì´ë„ˆ */
    .mic-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 20px;
    }

    .mic-button {
      width: clamp(80px, 20vw, 100px);
      height: clamp(80px, 20vw, 100px);
      border-radius: 50%;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: clamp(2rem, 6vw, 2.5rem);
      transition: all 0.3s ease;
      position: relative;
    }

    .mic-button.inactive {
      background: rgba(255,255,255,0.1);
      box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    }

    .mic-button.ready {
      background: linear-gradient(135deg, #2ed573 0%, #7bed9f 100%);
      box-shadow: 0 0 20px rgba(46, 213, 115, 0.4);
    }

    .mic-button.listening {
      background: linear-gradient(135deg, #e94560 0%, #ff6b6b 100%);
      box-shadow: 0 0 30px rgba(233, 69, 96, 0.5);
      animation: pulse 1.5s ease-in-out infinite;
    }

    .mic-button.processing {
      background: linear-gradient(135deg, #ffa502 0%, #ff6348 100%);
      box-shadow: 0 0 20px rgba(255, 165, 2, 0.4);
    }

    .mic-status-text {
      color: rgba(255,255,255,0.7);
      font-size: clamp(0.8rem, 2.5vw, 0.95rem);
      margin-top: 10px;
      text-align: center;
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
        box-shadow: 0 0 30px rgba(233, 69, 96, 0.5);
      }
      50% {
        transform: scale(1.08);
        box-shadow: 0 0 50px rgba(233, 69, 96, 0.8);
      }
    }

    .dan-selection {
      margin-bottom: 20px;
      display: block;
    }

    .dan-selection.hide {
      display: none;
    }

    .dan-label {
      color: rgba(255,255,255,0.7);
      display: block;
      margin-bottom: 10px;
      text-align: center;
      font-size: clamp(0.85rem, 2.5vw, 1rem);
    }

    .dan-buttons {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
      justify-content: center;
    }

    .dan-btn {
      padding: clamp(8px, 2vw, 10px) clamp(10px, 2.5vw, 14px);
      border-radius: 10px;
      border: none;
      background: rgba(255,255,255,0.1);
      color: #fff;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.2s ease;
      font-family: 'Noto Sans KR', sans-serif;
      font-size: clamp(0.8rem, 2.5vw, 0.95rem);
    }

    .dan-btn:active {
      transform: scale(0.95);
    }

    .dan-btn.selected {
      background: linear-gradient(135deg, #e94560 0%, #ff6b6b 100%);
    }

    .controls {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .btn {
      padding: clamp(12px, 3vw, 15px) clamp(30px, 8vw, 45px);
      font-size: clamp(1rem, 3vw, 1.15rem);
      font-weight: bold;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Noto Sans KR', sans-serif;
    }

    .btn:active {
      transform: scale(0.96);
    }

    .btn-primary {
      background: linear-gradient(135deg, #e94560 0%, #ff6b6b 100%);
      color: #fff;
      box-shadow: 0 8px 25px rgba(233, 69, 96, 0.4);
    }

    .btn-secondary {
      padding: clamp(10px, 2.5vw, 12px) clamp(20px, 5vw, 28px);
      font-size: clamp(0.9rem, 2.5vw, 1rem);
      border: 2px solid rgba(255,255,255,0.3);
      background: transparent;
      color: #fff;
    }

    .btn.hide {
      display: none;
    }

    .history {
      margin-top: 25px;
      background: rgba(255,255,255,0.05);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 20px;
      width: 100%;
      max-width: 450px;
      border: 1px solid rgba(255,255,255,0.1);
      display: none;
    }

    .history.show {
      display: block;
    }

    .history h3 {
      color: #fff;
      margin-bottom: 12px;
      text-align: center;
      font-size: clamp(1rem, 3vw, 1.2rem);
    }

    .history-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .history-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      border-radius: 10px;
      font-size: clamp(0.85rem, 2.5vw, 1rem);
    }

    .history-item.correct {
      background: rgba(46, 213, 115, 0.15);
    }

    .history-item.wrong {
      background: rgba(255, 71, 87, 0.15);
    }

    .history-question {
      color: #fff;
    }

    .history-result {
      font-weight: bold;
    }

    .history-result.correct {
      color: #2ed573;
    }

    .history-result.wrong {
      color: #ff4757;
    }

    .manual-input {
      display: none;
      margin-top: 15px;
      text-align: center;
    }

    .manual-input.show {
      display: block;
    }

    .manual-input input {
      padding: 12px 15px;
      font-size: clamp(1rem, 3vw, 1.2rem);
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 12px;
      background: rgba(255,255,255,0.1);
      color: #fff;
      width: 100px;
      text-align: center;
      font-family: 'Noto Sans KR', sans-serif;
    }

    .manual-input input:focus {
      outline: none;
      border-color: #e94560;
    }

    .manual-input button {
      margin-left: 10px;
      padding: 12px 18px;
      font-size: clamp(0.9rem, 2.5vw, 1rem);
      border: none;
      border-radius: 12px;
      background: linear-gradient(135deg, #e94560 0%, #ff6b6b 100%);
      color: #fff;
      cursor: pointer;
      font-family: 'Noto Sans KR', sans-serif;
    }

    .manual-label {
      color: rgba(255,255,255,0.6);
      font-size: clamp(0.75rem, 2vw, 0.85rem);
      margin-bottom: 10px;
    }

    /* ëª¨ë°”ì¼ ëŒ€ì‘ */
    @media (max-width: 380px) {
      .dan-buttons {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (min-height: 700px) {
      .game-area {
        padding: 30px;
      }
    }

    /* iOS Safari ëŒ€ì‘ */
    @supports (-webkit-touch-callout: none) {
      body {
        min-height: -webkit-fill-available;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ¯ êµ¬êµ¬ë‹¨ì„ ì™¸ì!</h1>
    <p>ìŒì„±ìœ¼ë¡œ ë‹µí•˜ëŠ” êµ¬êµ¬ë‹¨ ê²Œì„</p>
  </div>

  <div class="score-board">
    <div class="score-item">
      <div class="score-label">ë¬¸ì œ</div>
      <div class="score-value"><span id="currentQ">0</span>/10</div>
    </div>
    <div class="score-item highlight">
      <div class="score-label">ì ìˆ˜</div>
      <div class="score-value" id="score">0</div>
    </div>
  </div>

  <div class="game-area">
    <div class="question-display" id="questionDisplay">
      <div class="question-text" id="questionText">0 Ã— 0</div>
    </div>

    <div class="message-box" id="messageBox">
      <p class="message-text" id="messageText">ì‹œì‘ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”!</p>
    </div>

    <div class="user-answer" id="userAnswerBox">
      ë“¤ì€ ë‹µë³€: <span id="userAnswer"></span>
    </div>

    <!-- ë§ˆì´í¬ ë²„íŠ¼ -->
    <div class="mic-container" id="micContainer">
      <button class="mic-button inactive" id="micButton">ğŸ¤</button>
      <div class="mic-status-text" id="micStatusText">ê²Œì„ì„ ì‹œì‘í•˜ë©´ í™œì„±í™”ë©ë‹ˆë‹¤</div>
    </div>

    <div class="dan-selection" id="danSelection">
      <label class="dan-label">ì—°ìŠµí•  ë‹¨ ì„ íƒ</label>
      <div class="dan-buttons" id="danButtons">
        <button class="dan-btn selected" data-dan="0">ëœë¤</button>
        <button class="dan-btn" data-dan="2">2ë‹¨</button>
        <button class="dan-btn" data-dan="3">3ë‹¨</button>
        <button class="dan-btn" data-dan="4">4ë‹¨</button>
        <button class="dan-btn" data-dan="5">5ë‹¨</button>
        <button class="dan-btn" data-dan="6">6ë‹¨</button>
        <button class="dan-btn" data-dan="7">7ë‹¨</button>
        <button class="dan-btn" data-dan="8">8ë‹¨</button>
        <button class="dan-btn" data-dan="9">9ë‹¨</button>
      </div>
    </div>

    <div class="controls">
      <button class="btn btn-primary" id="startBtn">ğŸ® ê²Œì„ ì‹œì‘</button>
      <button class="btn btn-secondary hide" id="stopBtn">â¹ï¸ ê·¸ë§Œí•˜ê¸°</button>
      <button class="btn btn-primary hide" id="restartBtn">ğŸ”„ ë‹¤ì‹œ í•˜ê¸°</button>
    </div>

    <!-- ìˆ˜ë™ ì…ë ¥ ì˜µì…˜ -->
    <div class="manual-input" id="manualInput">
      <div class="manual-label">ìŒì„±ì´ ì•ˆ ë˜ë©´ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”</div>
      <input type="number" inputmode="numeric" pattern="[0-9]*" id="manualAnswer" placeholder="ë‹µ">
      <button id="submitManual">í™•ì¸</button>
    </div>
  </div>

  <div class="history" id="history">
    <h3>ğŸ“‹ ê²°ê³¼</h3>
    <div class="history-list" id="historyList"></div>
  </div>

  <script>
    // ë””ë°”ì´ìŠ¤ ê°ì§€
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    console.log('ë””ë°”ì´ìŠ¤:', isMobile ? 'ëª¨ë°”ì¼' : 'PC');

    // í•œê¸€ ìˆ«ì -> ì•„ë¼ë¹„ì•„ ìˆ«ì ë³€í™˜
    const koreanNumbers = {
      'ì˜': 0, 'ê³µ': 0, 'ë¹µ': 0, 'ë ¹': 0,
      'ì¼': 1, 'í•˜ë‚˜': 1, 'í•œ': 1,
      'ì´': 2, 'ë‘˜': 2, 'ë‘': 2,
      'ì‚¼': 3, 'ì…‹': 3, 'ì„¸': 3, 'ì„': 3,
      'ì‚¬': 4, 'ë„·': 4, 'ë„¤': 4,
      'ì˜¤': 5, 'ë‹¤ì„¯': 5,
      'ìœ¡': 6, 'ì—¬ì„¯': 6, 'ë¥™': 6,
      'ì¹ ': 7, 'ì¼ê³±': 7,
      'íŒ”': 8, 'ì—¬ëŸ': 8,
      'êµ¬': 9, 'ì•„í™‰': 9,
      'ì‹­': 10, 'ì—´': 10,
      'ë°±': 100
    };

    const soundAlikeNumbers = {
      'ì‚¬ì‹­': 40, 'ì˜¤ì‹­': 50, 'ìœ¡ì‹­': 60, 'ì¹ ì‹­': 70, 'íŒ”ì‹­': 80, 'êµ¬ì‹­': 90,
      'ì´ì‹­': 20, 'ì‚¼ì‹­': 30,
      'ì‚¬ì´': 4, 'ë‹¤ì‹œ': 5, 'ì—¬ì‹œ': 6,
      '12': 12, '24': 24, '36': 36, '48': 48,
      'ì„œë¥¸ì—¬ì„¯': 36, 'ë§ˆí”ì—¬ëŸ': 48, 'ì‰°ë„·': 54,
      'ì˜ˆìˆœì‚¼': 63, 'ì¼í”ë‘˜': 72, 'ì—¬ë“ í•˜ë‚˜': 81
    };

    function koreanToNumber(str) {
      str = str.trim().replace(/[.,!?]/g, '');
      
      const arabicMatch = str.match(/\d+/);
      if (arabicMatch) {
        return parseInt(arabicMatch[0]);
      }

      for (const [word, value] of Object.entries(soundAlikeNumbers)) {
        if (str.includes(word)) {
          return value;
        }
      }

      let result = 0;
      let original = str.replace(/\s/g, '');
      
      const specialTens = {
        'ìŠ¤ë¬¼': 20, 'ìŠ¤ë¬´': 20,
        'ì„œë¥¸': 30,
        'ë§ˆí”': 40,
        'ì‰°': 50, 'ì‰½': 50,
        'ì˜ˆìˆœ': 60,
        'ì¼í”': 70,
        'ì—¬ë“ ': 80,
        'ì•„í”': 90
      };

      for (const [word, value] of Object.entries(specialTens)) {
        if (original.includes(word)) {
          result += value;
          original = original.replace(word, '');
        }
      }

      const tenPatterns = [
        { pattern: 'ì´ì‹­', value: 20 },
        { pattern: 'ì‚¼ì‹­', value: 30 },
        { pattern: 'ì‚¬ì‹­', value: 40 },
        { pattern: 'ì˜¤ì‹­', value: 50 },
        { pattern: 'ìœ¡ì‹­', value: 60 },
        { pattern: 'ì¹ ì‹­', value: 70 },
        { pattern: 'íŒ”ì‹­', value: 80 },
        { pattern: 'êµ¬ì‹­', value: 90 }
      ];

      for (const { pattern, value } of tenPatterns) {
        if (original.includes(pattern)) {
          result += value;
          original = original.replace(pattern, '');
        }
      }

      if (original.includes('ì‹­') || original.includes('ì—´')) {
        const tenIdx = original.indexOf('ì‹­') !== -1 ? original.indexOf('ì‹­') : original.indexOf('ì—´');
        const beforeTen = original.substring(0, tenIdx);
        const afterTen = original.substring(tenIdx + 1);
        
        let tens = 1;
        for (const [word, value] of Object.entries(koreanNumbers)) {
          if (beforeTen.includes(word) && value >= 1 && value <= 9) {
            tens = value;
            break;
          }
        }
        if (result === 0) {
          result += tens * 10;
        }
        original = afterTen;
      }

      for (const [word, value] of Object.entries(koreanNumbers)) {
        if (original.includes(word) && value >= 1 && value <= 9) {
          result += value;
          break;
        }
      }

      if (result === 0) {
        for (const [word, value] of Object.entries(koreanNumbers)) {
          if (str.includes(word)) {
            return value;
          }
        }
      }

      return result > 0 ? result : null;
    }

    // Game State
    let gameState = 'ready';
    let currentQuestion = null;
    let score = 0;
    let totalQuestions = 0;
    let selectedDan = 0;
    let history = [];
    let recognition = null;
    let retryCount = 0;
    let audioContext = null;
    let micStream = null;
    let waitingForAnswer = false;
    let isRecording = false;
    const synth = window.speechSynthesis;

    // DOM Elements
    const questionDisplay = document.getElementById('questionDisplay');
    const questionText = document.getElementById('questionText');
    const messageBox = document.getElementById('messageBox');
    const messageText = document.getElementById('messageText');
    const userAnswerBox = document.getElementById('userAnswerBox');
    const userAnswer = document.getElementById('userAnswer');
    const micContainer = document.getElementById('micContainer');
    const micButton = document.getElementById('micButton');
    const micStatusText = document.getElementById('micStatusText');
    const danSelection = document.getElementById('danSelection');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const restartBtn = document.getElementById('restartBtn');
    const scoreEl = document.getElementById('score');
    const currentQEl = document.getElementById('currentQ');
    const historyEl = document.getElementById('history');
    const historyList = document.getElementById('historyList');
    const danButtons = document.querySelectorAll('.dan-btn');
    const manualInput = document.getElementById('manualInput');
    const manualAnswer = document.getElementById('manualAnswer');
    const submitManual = document.getElementById('submitManual');

    // ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ ìƒì„± (ë§ˆì´í¬ ê¶Œí•œ ìœ ì§€ìš©)
    async function initAudio() {
      console.log('ğŸ”§ initAudio ì‹œì‘');
      try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        console.log(`AudioContext ìƒíƒœ: ${audioContext.state}`);
        
        micStream = await navigator.mediaDevices.getUserMedia({ 
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: true,
            channelCount: 1,
            sampleRate: 48000,
            sampleSize: 16
          } 
        });
        
        console.log(`âœ… ë§ˆì´í¬ ìŠ¤íŠ¸ë¦¼ íšë“ (active: ${micStream.active})`);
        
        const source = audioContext.createMediaStreamSource(micStream);
        
        micButton.className = 'mic-button ready';
        
        if (isMobile) {
          micStatusText.textContent = 'ë§ˆì´í¬ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë…¹ìŒí•˜ì„¸ìš”';
        } else {
          micStatusText.textContent = 'ë§ˆì´í¬ ì¤€ë¹„ ì™„ë£Œ';
        }
        
        initRecognition();
        
        return true;
      } catch (err) {
        console.error(`âŒ ë§ˆì´í¬ ì´ˆê¸°í™” ì‹¤íŒ¨: ${err.message}`);
        micButton.className = 'mic-button inactive';
        micStatusText.textContent = 'ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤';
        manualInput.classList.add('show');
        return false;
      }
    }

    // Speech Recognition ì´ˆê¸°í™”
    function initRecognition() {
      if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
        micStatusText.textContent = 'ìŒì„±ì¸ì‹ ë¯¸ì§€ì› ë¸Œë¼ìš°ì €';
        console.log('âŒ SpeechRecognition ë¯¸ì§€ì›');
        manualInput.classList.add('show');
        return;
      }

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.lang = 'ko-KR';
      
      // PCëŠ” continuous, ëª¨ë°”ì¼ì€ í•œë²ˆë§Œ
      if (isMobile) {
        recognition.continuous = false;
        recognition.interimResults = false;
      } else {
        recognition.continuous = true;
        recognition.interimResults = true;
      }
      
      recognition.maxAlternatives = 5;
      
      console.log('âœ… Recognition ê°ì²´ ìƒì„±ë¨ (continuous:', recognition.continuous, ')');

      let lastTranscript = '';
      let silenceTimer = null;

      recognition.onstart = () => {
        console.log('ğŸ™ï¸ ìŒì„±ì¸ì‹ ì‹œì‘ë¨');
        isRecording = true;
      };

      recognition.onresult = (event) => {
        console.log(`ğŸ“ onresult í˜¸ì¶œ (waitingForAnswer: ${waitingForAnswer})`);
        
        if (!waitingForAnswer) {
          console.log('âš ï¸ waitingForAnswer=false, ë¬´ì‹œë¨');
          return;
        }

        let transcript = '';
        
        for (let i = event.resultIndex; i < event.results.length; i++) {
          transcript = event.results[i][0].transcript;
          const isFinal = event.results[i].isFinal;
          const confidence = event.results[i][0].confidence;
          
          console.log(`ê²°ê³¼[${i}]: "${transcript}" (final:${isFinal}, conf:${confidence?.toFixed(2)})`);
          
          if (isFinal) {
            waitingForAnswer = false;
            clearTimeout(silenceTimer);
            processAnswer(transcript);
            
            // ëª¨ë°”ì¼ì€ ì—¬ê¸°ì„œ recognition ì¤‘ì§€
            if (isMobile) {
              recognition.stop();
            }
            return;
          }
        }
        
        // PC ì „ìš©: ì¤‘ê°„ ê²°ê³¼ ì²˜ë¦¬
        if (!isMobile && transcript && transcript !== lastTranscript) {
          lastTranscript = transcript;
          const potentialAnswer = koreanToNumber(transcript);
          console.log(`ì¤‘ê°„ê²°ê³¼: "${transcript}" â†’ ìˆ«ì: ${potentialAnswer}`);
          
          if (potentialAnswer !== null) {
            clearTimeout(silenceTimer);
            silenceTimer = setTimeout(() => {
              if (waitingForAnswer) {
                waitingForAnswer = false;
                processAnswer(transcript);
              }
            }, 800);
          }
        }
      };

      recognition.onerror = (event) => {
        console.log(`âŒ ì—ëŸ¬: ${event.error}`);
        isRecording = false;
        
        if (event.error === 'not-allowed') {
          micButton.className = 'mic-button inactive';
          micStatusText.textContent = 'ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”';
          manualInput.classList.add('show');
        } else if (event.error === 'no-speech') {
          console.log('âš ï¸ ìŒì„± ì—†ìŒ ê°ì§€');
          if (isMobile && waitingForAnswer) {
            handleNoSpeech();
          }
        }
      };

      recognition.onend = () => {
        console.log(`ğŸ”´ Recognition ì¢…ë£Œ (gameState: ${gameState}, isMobile: ${isMobile}, isRecording: ${isRecording})`);
        isRecording = false;
        
        // ëª¨ë°”ì¼: ë²„íŠ¼ìœ¼ë¡œ ì œì–´í•˜ë¯€ë¡œ ìë™ ì¬ì‹œì‘ ì ˆëŒ€ ì•ˆ í•¨
        if (isMobile) {
          console.log('ğŸ“± ëª¨ë°”ì¼: ìë™ ì¬ì‹œì‘ ì•ˆ í•¨');
          if (waitingForAnswer) {
            updateMicStatus(false);
          }
          return;
        }
        
        // PC: ê²Œì„ ì¤‘ì´ë©´ ìë™ ì¬ì‹œì‘
        if (gameState === 'playing' && micStream && micStream.active && waitingForAnswer) {
          setTimeout(() => {
            try {
              if (waitingForAnswer) { // ë‹¤ì‹œ í•œë²ˆ ì²´í¬
                recognition.start();
                console.log('ğŸ”„ Recognition ì¬ì‹œì‘ (PC)');
              }
            } catch (e) {
              console.log(`âš ï¸ ì¬ì‹œì‘ ì‹¤íŒ¨: ${e.message}`);
            }
          }, 100);
        }
      };
    }

    // ìŒì„± ì¸ì‹ ì‹œì‘
    function startRecognition() {
      console.log(`ğŸš€ startRecognition í˜¸ì¶œ (isMobile: ${isMobile}, isRecording: ${isRecording})`);
      if (!recognition) {
        console.log('âŒ recognition ê°ì²´ ì—†ìŒ!');
        return;
      }
      
      // ì´ë¯¸ ë…¹ìŒ ì¤‘ì´ë©´ ì¤‘ì§€í•˜ê³  ì¬ì‹œì‘
      if (isRecording) {
        console.log('âš ï¸ ì´ë¯¸ ë…¹ìŒ ì¤‘ - ì¤‘ì§€ í›„ ì¬ì‹œì‘');
        try {
          recognition.stop();
        } catch (e) {
          console.log('ì¤‘ì§€ ì‹¤íŒ¨:', e.message);
        }
        // ì ì‹œ ëŒ€ê¸° í›„ ì‹œì‘
        setTimeout(() => {
          startRecognitionInternal();
        }, 200);
      } else {
        startRecognitionInternal();
      }
    }

    function startRecognitionInternal() {
      try {
        recognition.start();
        console.log('âœ… recognition.start() í˜¸ì¶œë¨');
        isRecording = true;
        updateMicStatus(true);
      } catch (e) {
        console.log(`âš ï¸ start ì—ëŸ¬: ${e.message}`);
        if (e.message.includes('already started')) {
          console.log('ì´ë¯¸ ì‹œì‘ë¨ - ìƒíƒœë§Œ ì—…ë°ì´íŠ¸');
          isRecording = true;
          updateMicStatus(true);
        }
      }
    }

    // ìŒì„± ì¸ì‹ ì¤‘ì§€
    function stopRecognition() {
      if (recognition && isRecording) {
        try {
          recognition.stop();
          console.log('ğŸ›‘ recognition.stop() í˜¸ì¶œë¨');
          isRecording = false;
        } catch (e) {}
      }
    }

    // TTS
    function speak(text, onEnd) {
      synth.cancel();
      
      // PCëŠ” TTS ì¤‘ ìŒì„±ì¸ì‹ ì¤‘ì§€
      if (!isMobile) {
        stopRecognition();
      }
      
      console.log(`ğŸ”Š TTS ì‹œì‘: "${text}"`);
      
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'ko-KR';
      utterance.rate = 0.9;
      utterance.pitch = 1;
      
      utterance.onend = () => {
        console.log('ğŸ”Š TTS ì™„ë£Œ');
        
        // PCëŠ” TTS ëë‚˜ë©´ ìë™ìœ¼ë¡œ ìŒì„±ì¸ì‹ ì¬ì‹œì‘
        if (!isMobile && (gameState === 'playing' || gameState === 'listening')) {
          setTimeout(() => {
            console.log('ğŸ¯ TTS í›„ recognition ì‹œì‘ (PC)');
            startRecognition();
          }, 500);
        }
        
        if (onEnd) onEnd();
      };
      
      synth.speak(utterance);
    }

    // ë¬¸ì œ ìƒì„±
    function generateQuestion() {
      const dan = selectedDan === 0 ? Math.floor(Math.random() * 8) + 2 : selectedDan;
      const num = Math.floor(Math.random() * 9) + 1;
      return { dan, num, answer: dan * num };
    }

    function updateScore() {
      scoreEl.textContent = score;
      currentQEl.textContent = totalQuestions;
    }

    function setMessage(text, state = '') {
      messageText.textContent = text;
      messageBox.className = 'message-box' + (state ? ' ' + state : '');
    }

    function updateMicStatus(isListening) {
      if (isListening) {
        micButton.className = 'mic-button listening';
        if (isMobile) {
          micStatusText.textContent = 'ë…¹ìŒ ì¤‘... (ë‹¤ì‹œ ëˆ„ë¥´ë©´ ì¤‘ì§€)';
        } else {
          micStatusText.textContent = 'ë“£ê³  ìˆì–´ìš”... í¬ê²Œ ë§í•´ì£¼ì„¸ìš”!';
        }
      } else if (micStream && micStream.active) {
        micButton.className = 'mic-button ready';
        if (isMobile) {
          micStatusText.textContent = 'ë§ˆì´í¬ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë…¹ìŒí•˜ì„¸ìš”';
        } else {
          micStatusText.textContent = 'ë§ˆì´í¬ ì¤€ë¹„ë¨';
        }
      } else {
        micButton.className = 'mic-button inactive';
        micStatusText.textContent = 'ë§ˆì´í¬ ë¹„í™œì„±í™”';
      }
    }

    // ë‹µë³€ ëŒ€ê¸° ì‹œì‘
    let answerTimeout = null;
    
    function startListening() {
      console.log(`ğŸ¯ startListening í˜¸ì¶œ`);
      gameState = 'listening';
      waitingForAnswer = true;
      manualInput.classList.remove('show');
      
      // PCëŠ” ìë™ìœ¼ë¡œ ìŒì„±ì¸ì‹ ì‹œì‘
      if (!isMobile) {
        updateMicStatus(true);
        // PCëŠ” ì¦‰ì‹œ íƒ€ì„ì•„ì›ƒ ì‹œì‘ (5ì´ˆ)
        answerTimeout = setTimeout(() => {
          if (waitingForAnswer) {
            console.log('â° PC 5ì´ˆ íƒ€ì„ì•„ì›ƒ');
            handleNoSpeech();
          }
        }, 5000);
      } else {
        // ëª¨ë°”ì¼ì€ ë²„íŠ¼ ëˆ„ë¥´ë©´ ì‹œì‘ (íƒ€ì„ì•„ì›ƒë„ ë²„íŠ¼ ëˆ„ë¥¸ í›„ ì‹œì‘)
        updateMicStatus(false);
      }
    }

    function processAnswer(transcript) {
      console.log(`âœ… processAnswer: "${transcript}"`);
      
      // íƒ€ì„ì•„ì›ƒ í´ë¦¬ì–´
      if (answerTimeout) {
        clearTimeout(answerTimeout);
        answerTimeout = null;
      }
      
      updateMicStatus(false);
      
      const answer = koreanToNumber(transcript);
      console.log(`ë³€í™˜ ê²°ê³¼: ${answer}`);

      userAnswer.textContent = transcript + (answer !== null ? ` (${answer})` : '');
      userAnswerBox.classList.add('show');

      if (answer !== null) {
        checkAnswer(answer);
      } else {
        handleNoSpeech();
      }
    }

    function handleNoSpeech() {
      // íƒ€ì„ì•„ì›ƒ í´ë¦¬ì–´
      if (answerTimeout) {
        clearTimeout(answerTimeout);
        answerTimeout = null;
      }
      
      waitingForAnswer = false;
      updateMicStatus(false);
      retryCount++;
      
      if (retryCount >= 3) {
        setMessage('ìŒì„± ì¸ì‹ì´ ì–´ë ¤ì›Œìš”. ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”!');
        manualInput.classList.add('show');
      } else {
        setMessage('ì˜ ëª» ë“¤ì—ˆì–´ìš”. ë‹¤ì‹œ ë§í•´ì£¼ì„¸ìš”!');
        speak('ë‹¤ì‹œ í•œë²ˆ ë§í•´ì£¼ì„¸ìš”!', () => {
          setTimeout(() => {
            waitingForAnswer = true;
            gameState = 'listening';
            
            // PCëŠ” ìë™ ì¬ì‹œì‘, ëª¨ë°”ì¼ì€ ë²„íŠ¼ ëŒ€ê¸°
            if (!isMobile) {
              updateMicStatus(true);
              // PCëŠ” ë‹¤ì‹œ íƒ€ì„ì•„ì›ƒ ì‹œì‘ (5ì´ˆ)
              answerTimeout = setTimeout(() => {
                if (waitingForAnswer) {
                  console.log('â° PC ì¬ì‹œë„ íƒ€ì„ì•„ì›ƒ');
                  handleNoSpeech();
                }
              }, 5000);
            } else {
              updateMicStatus(false);
              // ëª¨ë°”ì¼ì€ ë²„íŠ¼ ëˆ„ë¥¼ ë•Œê¹Œì§€ ëŒ€ê¸°
            }
          }, 500);
        });
      }
    }

    function checkAnswer(answer) {
      if (!currentQuestion) return;

      // íƒ€ì„ì•„ì›ƒ í´ë¦¬ì–´
      if (answerTimeout) {
        clearTimeout(answerTimeout);
        answerTimeout = null;
      }

      retryCount = 0;
      manualInput.classList.remove('show');

      const isCorrect = answer === currentQuestion.answer;

      history.push({
        question: `${currentQuestion.dan} Ã— ${currentQuestion.num}`,
        correctAnswer: currentQuestion.answer,
        userAnswer: answer,
        isCorrect
      });

      if (isCorrect) {
        score++;
        updateScore();
        gameState = 'correct';
        setMessage('ì •ë‹µì´ì—ìš”! ğŸ‰', 'correct');
        speak('ë”©ë™ëŒ•! ì •ë‹µì´ì—ìš”!', () => {
          setTimeout(nextQuestion, 1000);
        });
      } else {
        gameState = 'wrong';
        setMessage(`í‹€ë ¸ì–´ìš”! ì •ë‹µì€ ${currentQuestion.answer}ì´ì—ìš”`, 'wrong');
        speak(`í‹€ë ¸ì–´ìš”. ì •ë‹µì€ ${currentQuestion.answer}ì…ë‹ˆë‹¤.`, () => {
          setTimeout(nextQuestion, 1500);
        });
      }
    }

    function nextQuestion() {
      if (totalQuestions >= 10) {
        finishGame();
        return;
      }

      retryCount = 0;
      currentQuestion = generateQuestion();
      totalQuestions++;
      updateScore();
      userAnswerBox.classList.remove('show');
      manualInput.classList.remove('show');
      gameState = 'playing';

      questionText.textContent = `${currentQuestion.dan} Ã— ${currentQuestion.num}`;
      questionDisplay.classList.add('show');

      const questionSpeech = `${currentQuestion.dan} ê³±í•˜ê¸° ${currentQuestion.num}ì€?`;
      setMessage(questionSpeech);

      speak(questionSpeech, () => {
        setTimeout(startListening, 500);
      });
    }

    function finishGame() {
      gameState = 'finished';
      waitingForAnswer = false;
      
      // íƒ€ì„ì•„ì›ƒ í´ë¦¬ì–´
      if (answerTimeout) {
        clearTimeout(answerTimeout);
        answerTimeout = null;
      }
      
      stopRecognition();
      
      questionDisplay.classList.remove('show');
      manualInput.classList.remove('show');
      updateMicStatus(false);
      setMessage(`ê²Œì„ ë! ${score}ì ì„ ë°›ì•˜ì–´ìš”!`);
      speak(`ê²Œì„ì´ ëë‚¬ìŠµë‹ˆë‹¤. ì—´ ë¬¸ì œ ì¤‘ ${score}ê°œë¥¼ ë§í˜”ì–´ìš”!`);

      startBtn.classList.add('hide');
      stopBtn.classList.add('hide');
      restartBtn.classList.remove('hide');
      danSelection.classList.remove('hide');
      
      // ë§ˆì´í¬ ìŠ¤íŠ¸ë¦¼ì€ ìœ ì§€ (ê¶Œí•œ ìœ ì§€)
      if (micStream && micStream.active) {
        micStatusText.textContent = 'ê²Œì„ ì¢…ë£Œ - ë‹¤ì‹œí•˜ê¸°ë¥¼ ëˆ„ë¥´ì„¸ìš”';
      } else {
        micStatusText.textContent = 'ê²Œì„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤';
      }

      // ê²°ê³¼ í‘œì‹œ
      historyList.innerHTML = '';
      history.forEach(item => {
        const div = document.createElement('div');
        div.className = 'history-item ' + (item.isCorrect ? 'correct' : 'wrong');
        div.innerHTML = `
          <span class="history-question">${item.question} = ${item.correctAnswer}</span>
          <span class="history-result ${item.isCorrect ? 'correct' : 'wrong'}">
            ${item.isCorrect ? 'â­•' : `âŒ (${item.userAnswer})`}
          </span>
        `;
        historyList.appendChild(div);
      });
      historyEl.classList.add('show');
    }

    async function startGame() {
      // ì²« ì‹œì‘ì‹œ ì˜¤ë””ì˜¤ ì´ˆê¸°í™”
      if (!micStream) {
        const success = await initAudio();
        if (!success) {
          // ë§ˆì´í¬ ì—†ì–´ë„ ìˆ˜ë™ ì…ë ¥ìœ¼ë¡œ ì§„í–‰ ê°€ëŠ¥
        }
      }

      // AudioContext resume (ëª¨ë°”ì¼ ëŒ€ì‘)
      if (audioContext && audioContext.state === 'suspended') {
        await audioContext.resume();
      }

      score = 0;
      totalQuestions = 0;
      history = [];
      retryCount = 0;
      updateScore();
      historyEl.classList.remove('show');
      userAnswerBox.classList.remove('show');
      manualInput.classList.remove('show');

      startBtn.classList.add('hide');
      restartBtn.classList.add('hide');
      stopBtn.classList.remove('hide');
      danSelection.classList.add('hide');

      gameState = 'playing';
      
      speak('êµ¬êµ¬ë‹¨ ê²Œì„ì„ ì‹œì‘í•©ë‹ˆë‹¤!', () => {
        setTimeout(nextQuestion, 500);
      });
    }

    function resetGame() {
      synth.cancel();
      waitingForAnswer = false;
      
      // íƒ€ì„ì•„ì›ƒ í´ë¦¬ì–´
      if (answerTimeout) {
        clearTimeout(answerTimeout);
        answerTimeout = null;
      }
      
      stopRecognition();

      gameState = 'ready';
      currentQuestion = null;
      score = 0;
      totalQuestions = 0;
      history = [];
      retryCount = 0;
      updateScore();

      questionDisplay.classList.remove('show');
      userAnswerBox.classList.remove('show');
      historyEl.classList.remove('show');
      manualInput.classList.remove('show');
      setMessage('ì‹œì‘ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”!');
      
      // ë§ˆì´í¬ ìŠ¤íŠ¸ë¦¼ì€ ìœ ì§€ (ê¶Œí•œ ìœ ì§€)
      if (micStream && micStream.active) {
        micButton.className = 'mic-button ready';
        if (isMobile) {
          micStatusText.textContent = 'ë§ˆì´í¬ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë…¹ìŒí•˜ì„¸ìš”';
        } else {
          micStatusText.textContent = 'ë§ˆì´í¬ ì¤€ë¹„ë¨';
        }
      } else {
        micButton.className = 'mic-button inactive';
        micStatusText.textContent = 'ê²Œì„ì„ ì‹œì‘í•˜ë©´ í™œì„±í™”ë©ë‹ˆë‹¤';
      }

      startBtn.classList.remove('hide');
      stopBtn.classList.add('hide');
      restartBtn.classList.add('hide');
      danSelection.classList.remove('hide');
    }

    // ë§ˆì´í¬ ë²„íŠ¼ í´ë¦­
    micButton.addEventListener('click', () => {
      if (gameState !== 'playing' && gameState !== 'listening') {
        return;
      }

      if (isMobile) {
        // ëª¨ë°”ì¼: ë²„íŠ¼ ëˆŒëŸ¬ì„œ ë…¹ìŒ ì‹œì‘/ì¤‘ì§€
        if (isRecording) {
          // ë…¹ìŒ ì¤‘ì´ë©´ ì¤‘ì§€
          stopRecognition();
          updateMicStatus(false);
          
          // íƒ€ì„ì•„ì›ƒ í´ë¦¬ì–´
          if (answerTimeout) {
            clearTimeout(answerTimeout);
            answerTimeout = null;
          }
        } else {
          // ë…¹ìŒ ì‹œì‘
          if (waitingForAnswer) {
            console.log('ğŸ“± ëª¨ë°”ì¼: ë…¹ìŒ ì‹œì‘ ì‹œë„');
            startRecognition();
            
            // ëª¨ë°”ì¼: ë²„íŠ¼ ëˆ„ë¥¸ ì‹œì ë¶€í„° íƒ€ì„ì•„ì›ƒ ì‹œì‘ (5ì´ˆ)
            answerTimeout = setTimeout(() => {
              if (waitingForAnswer && isRecording) {
                console.log('â° ëª¨ë°”ì¼ 5ì´ˆ íƒ€ì„ì•„ì›ƒ');
                stopRecognition();
                handleNoSpeech();
              }
            }, 5000);
          }
        }
      } else {
        // PC: ë‹¤ì‹œ ë“£ê¸°
        retryCount = 0;
        manualInput.classList.remove('show');
        
        // ê¸°ì¡´ íƒ€ì„ì•„ì›ƒ í´ë¦¬ì–´
        if (answerTimeout) {
          clearTimeout(answerTimeout);
          answerTimeout = null;
        }
        
        waitingForAnswer = false;
        
        setTimeout(() => {
          waitingForAnswer = true;
          updateMicStatus(true);
          
          // ìƒˆ íƒ€ì„ì•„ì›ƒ ì‹œì‘ (5ì´ˆ)
          answerTimeout = setTimeout(() => {
            if (waitingForAnswer) {
              console.log('â° PC ë‹¤ì‹œë“£ê¸° íƒ€ì„ì•„ì›ƒ');
              handleNoSpeech();
            }
          }, 5000);
        }, 300);
      }
    });

    // Event listeners
    startBtn.addEventListener('click', startGame);
    stopBtn.addEventListener('click', resetGame);
    restartBtn.addEventListener('click', startGame);

    submitManual.addEventListener('click', () => {
      const value = parseInt(manualAnswer.value);
      if (!isNaN(value)) {
        manualAnswer.value = '';
        userAnswer.textContent = value;
        userAnswerBox.classList.add('show');
        waitingForAnswer = false;
        updateMicStatus(false);
        checkAnswer(value);
      }
    });

    manualAnswer.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        submitManual.click();
      }
    });

    danButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        danButtons.forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        selectedDan = parseInt(btn.dataset.dan);
      });
    });

    // í˜ì´ì§€ visibility ë³€ê²½ ì‹œ ì²˜ë¦¬
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        stopRecognition();
      } else if (!isMobile && (gameState === 'playing' || gameState === 'listening')) {
        startRecognition();
      }
    });

    // í˜ì´ì§€ ì¢…ë£Œ ì‹œ ìŠ¤íŠ¸ë¦¼ ì •ë¦¬ (ë¸Œë¼ìš°ì € ì¢…ë£Œ/íƒ­ ë‹«ê¸°)
    window.addEventListener('beforeunload', () => {
      if (micStream) {
        micStream.getTracks().forEach(track => track.stop());
      }
      if (audioContext) {
        audioContext.close();
      }
    });
  </script>
</body>
</html>
