<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>êµ¬êµ¬ë‹¨ì„ ì™¸ì! ğŸ¯</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&family=Black+Han+Sans&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      font-family: 'Noto Sans KR', sans-serif;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .header h1 {
      font-family: 'Black Han Sans', sans-serif;
      font-size: clamp(2.5rem, 8vw, 4rem);
      color: #fff;
      text-shadow: 0 0 30px rgba(233, 69, 96, 0.5), 0 4px 0 #e94560;
      letter-spacing: 2px;
    }

    .header p {
      color: rgba(255,255,255,0.6);
      font-size: 1rem;
      margin-top: 10px;
    }

    .score-board {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
    }

    .score-item {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 15px 30px;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.2);
    }

    .score-item.highlight {
      background: linear-gradient(135deg, #e94560 0%, #ff6b6b 100%);
      box-shadow: 0 10px 30px rgba(233, 69, 96, 0.3);
      border: none;
    }

    .score-label {
      color: rgba(255,255,255,0.6);
      font-size: 0.8rem;
    }

    .highlight .score-label {
      color: rgba(255,255,255,0.8);
    }

    .score-value {
      color: #fff;
      font-size: 1.8rem;
      font-weight: bold;
    }

    .game-area {
      background: rgba(255,255,255,0.05);
      backdrop-filter: blur(20px);
      border-radius: 30px;
      padding: 40px;
      width: 100%;
      max-width: 500px;
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .question-display {
      text-align: center;
      margin-bottom: 30px;
      display: none;
    }

    .question-display.show {
      display: block;
    }

    .question-text {
      font-size: clamp(3rem, 12vw, 5rem);
      font-weight: 900;
      color: #fff;
      text-shadow: 0 0 40px rgba(233, 69, 96, 0.3);
    }

    .message-box {
      text-align: center;
      padding: 20px;
      border-radius: 15px;
      background: rgba(255,255,255,0.05);
      margin-bottom: 20px;
      transition: all 0.3s ease;
    }

    .message-box.correct {
      background: rgba(46, 213, 115, 0.2);
    }

    .message-box.wrong {
      background: rgba(255, 71, 87, 0.2);
    }

    .message-text {
      color: #fff;
      font-size: 1.3rem;
      font-weight: bold;
    }

    .message-box.correct .message-text {
      color: #2ed573;
    }

    .message-box.wrong .message-text {
      color: #ff4757;
    }

    .user-answer {
      text-align: center;
      margin-bottom: 20px;
      color: rgba(255,255,255,0.7);
      font-size: 1rem;
      display: none;
    }

    .user-answer.show {
      display: block;
    }

    .user-answer span {
      color: #fff;
      font-weight: bold;
    }

    .listening-indicator {
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }

    .listening-indicator.show {
      display: flex;
    }

    .mic-icon {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(135deg, #e94560 0%, #ff6b6b 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      animation: pulse 1.5s ease-in-out infinite;
      box-shadow: 0 0 30px rgba(233, 69, 96, 0.5);
      font-size: 2rem;
    }

    .listening-text {
      color: #fff;
      font-size: 1.1rem;
    }

    .listening-hint {
      color: rgba(255,255,255,0.5);
      font-size: 0.85rem;
      margin-top: 5px;
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
        box-shadow: 0 0 30px rgba(233, 69, 96, 0.5);
      }
      50% {
        transform: scale(1.1);
        box-shadow: 0 0 50px rgba(233, 69, 96, 0.8);
      }
    }

    .dan-selection {
      margin-bottom: 20px;
      display: block;
    }

    .dan-selection.hide {
      display: none;
    }

    .dan-label {
      color: rgba(255,255,255,0.7);
      display: block;
      margin-bottom: 10px;
      text-align: center;
    }

    .dan-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
    }

    .dan-btn {
      padding: 10px 16px;
      border-radius: 10px;
      border: none;
      background: rgba(255,255,255,0.1);
      color: #fff;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.2s ease;
      font-family: 'Noto Sans KR', sans-serif;
    }

    .dan-btn:hover {
      transform: translateY(-2px);
    }

    .dan-btn.selected {
      background: linear-gradient(135deg, #e94560 0%, #ff6b6b 100%);
    }

    .controls {
      display: flex;
      gap: 15px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .btn {
      padding: 15px 50px;
      font-size: 1.2rem;
      font-weight: bold;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Noto Sans KR', sans-serif;
    }

    .btn:hover {
      transform: translateY(-2px);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-primary {
      background: linear-gradient(135deg, #e94560 0%, #ff6b6b 100%);
      color: #fff;
      box-shadow: 0 10px 30px rgba(233, 69, 96, 0.4);
    }

    .btn-secondary {
      padding: 12px 30px;
      font-size: 1rem;
      border: 2px solid rgba(255,255,255,0.3);
      background: transparent;
      color: #fff;
    }

    .btn-retry {
      padding: 12px 25px;
      font-size: 1rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
    }

    .btn.hide {
      display: none;
    }

    .history {
      margin-top: 30px;
      background: rgba(255,255,255,0.05);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 25px;
      width: 100%;
      max-width: 500px;
      border: 1px solid rgba(255,255,255,0.1);
      display: none;
    }

    .history.show {
      display: block;
    }

    .history h3 {
      color: #fff;
      margin-bottom: 15px;
      text-align: center;
    }

    .history-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .history-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 15px;
      border-radius: 10px;
    }

    .history-item.correct {
      background: rgba(46, 213, 115, 0.15);
    }

    .history-item.wrong {
      background: rgba(255, 71, 87, 0.15);
    }

    .history-question {
      color: #fff;
    }

    .history-result {
      font-weight: bold;
    }

    .history-result.correct {
      color: #2ed573;
    }

    .history-result.wrong {
      color: #ff4757;
    }

    .manual-input {
      display: none;
      margin-top: 15px;
      text-align: center;
    }

    .manual-input.show {
      display: block;
    }

    .manual-input input {
      padding: 12px 20px;
      font-size: 1.2rem;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 15px;
      background: rgba(255,255,255,0.1);
      color: #fff;
      width: 120px;
      text-align: center;
      font-family: 'Noto Sans KR', sans-serif;
    }

    .manual-input input:focus {
      outline: none;
      border-color: #e94560;
    }

    .manual-input button {
      margin-left: 10px;
      padding: 12px 20px;
      font-size: 1rem;
      border: none;
      border-radius: 15px;
      background: linear-gradient(135deg, #e94560 0%, #ff6b6b 100%);
      color: #fff;
      cursor: pointer;
      font-family: 'Noto Sans KR', sans-serif;
    }

    .manual-label {
      color: rgba(255,255,255,0.6);
      font-size: 0.85rem;
      margin-bottom: 10px;
    }

    .mic-status {
      text-align: center;
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 0.85rem;
      margin-bottom: 15px;
      display: none;
    }

    .mic-status.show {
      display: block;
    }

    .mic-status.ready {
      background: rgba(46, 213, 115, 0.2);
      color: #2ed573;
    }

    .mic-status.error {
      background: rgba(255, 71, 87, 0.2);
      color: #ff4757;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ¯ êµ¬êµ¬ë‹¨ì„ ì™¸ì!</h1>
    <p>ìŒì„±ìœ¼ë¡œ ë‹µí•˜ëŠ” êµ¬êµ¬ë‹¨ ê²Œì„</p>
  </div>

  <div class="score-board">
    <div class="score-item">
      <div class="score-label">ë¬¸ì œ</div>
      <div class="score-value"><span id="currentQ">0</span>/10</div>
    </div>
    <div class="score-item highlight">
      <div class="score-label">ì ìˆ˜</div>
      <div class="score-value" id="score">0</div>
    </div>
  </div>

  <div class="game-area">
    <div class="mic-status" id="micStatus"></div>

    <div class="question-display" id="questionDisplay">
      <div class="question-text" id="questionText">0 Ã— 0</div>
    </div>

    <div class="message-box" id="messageBox">
      <p class="message-text" id="messageText">ì‹œì‘ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”!</p>
    </div>

    <div class="user-answer" id="userAnswerBox">
      ë“¤ì€ ë‹µë³€: <span id="userAnswer"></span>
    </div>

    <div class="listening-indicator" id="listeningIndicator">
      <div class="mic-icon">ğŸ¤</div>
      <span class="listening-text">ë“£ê³  ìˆì–´ìš”...</span>
      <span class="listening-hint">í¬ê²Œ ë˜ë°•ë˜ë°• ë§í•´ì£¼ì„¸ìš”!</span>
    </div>

    <div class="dan-selection" id="danSelection">
      <label class="dan-label">ì—°ìŠµí•  ë‹¨ ì„ íƒ</label>
      <div class="dan-buttons" id="danButtons">
        <button class="dan-btn selected" data-dan="0">ëœë¤</button>
        <button class="dan-btn" data-dan="2">2ë‹¨</button>
        <button class="dan-btn" data-dan="3">3ë‹¨</button>
        <button class="dan-btn" data-dan="4">4ë‹¨</button>
        <button class="dan-btn" data-dan="5">5ë‹¨</button>
        <button class="dan-btn" data-dan="6">6ë‹¨</button>
        <button class="dan-btn" data-dan="7">7ë‹¨</button>
        <button class="dan-btn" data-dan="8">8ë‹¨</button>
        <button class="dan-btn" data-dan="9">9ë‹¨</button>
      </div>
    </div>

    <div class="controls">
      <button class="btn btn-primary" id="startBtn">ğŸ® ê²Œì„ ì‹œì‘</button>
      <button class="btn btn-retry hide" id="retryBtn">ğŸ¤ ë‹¤ì‹œ ë§í•˜ê¸°</button>
      <button class="btn btn-secondary hide" id="stopBtn">â¹ï¸ ê·¸ë§Œí•˜ê¸°</button>
      <button class="btn btn-primary hide" id="restartBtn">ğŸ”„ ë‹¤ì‹œ í•˜ê¸°</button>
    </div>

    <!-- ìˆ˜ë™ ì…ë ¥ ì˜µì…˜ -->
    <div class="manual-input" id="manualInput">
      <div class="manual-label">ìŒì„±ì´ ì•ˆ ë˜ë©´ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”</div>
      <input type="number" id="manualAnswer" placeholder="ë‹µ">
      <button id="submitManual">í™•ì¸</button>
    </div>


  </div>

  <div class="history" id="history">
    <h3>ğŸ“‹ ê²°ê³¼</h3>
    <div class="history-list" id="historyList"></div>
  </div>

  <script>
    // í•œê¸€ ìˆ«ì -> ì•„ë¼ë¹„ì•„ ìˆ«ì ë³€í™˜ ë§µ
    const koreanNumbers = {
      'ì˜': 0, 'ê³µ': 0, 'ë¹µ': 0,
      'ì¼': 1, 'í•˜ë‚˜': 1,
      'ì´': 2, 'ë‘˜': 2,
      'ì‚¼': 3, 'ì…‹': 3, 'ì„¸': 3,
      'ì‚¬': 4, 'ë„·': 4, 'ë„¤': 4,
      'ì˜¤': 5, 'ë‹¤ì„¯': 5,
      'ìœ¡': 6, 'ì—¬ì„¯': 6,
      'ì¹ ': 7, 'ì¼ê³±': 7,
      'íŒ”': 8, 'ì—¬ëŸ': 8,
      'êµ¬': 9, 'ì•„í™‰': 9,
      'ì‹­': 10, 'ì—´': 10,
      'ë°±': 100
    };

    // í•œê¸€ ìˆ«ì ë¬¸ìì—´ì„ ìˆ«ìë¡œ ë³€í™˜
    function koreanToNumber(str) {
      // ë¨¼ì € ì•„ë¼ë¹„ì•„ ìˆ«ìê°€ ìˆëŠ”ì§€ í™•ì¸
      const arabicMatch = str.match(/\d+/);
      if (arabicMatch) {
        return parseInt(arabicMatch[0]);
      }

      // ê°„ë‹¨í•œ í•œê¸€ ìˆ«ì ì²˜ë¦¬ (1-99 ë²”ìœ„)
      let result = 0;
      
      // ê³µë°± ì œê±°í•˜ê³  ì²˜ë¦¬
      str = str.replace(/\s/g, '');
      
      // "ìŠ¤ë¬¼", "ì„œë¥¸" ë“±ì˜ íŠ¹ìˆ˜ í‘œí˜„
      const specialTens = {
        'ìŠ¤ë¬¼': 20, 'ìŠ¤ë¬´': 20,
        'ì„œë¥¸': 30,
        'ë§ˆí”': 40,
        'ì‰°': 50,
        'ì˜ˆìˆœ': 60,
        'ì¼í”': 70,
        'ì—¬ë“ ': 80,
        'ì•„í”': 90
      };

      // íŠ¹ìˆ˜ í‘œí˜„ ë¨¼ì € ì²˜ë¦¬
      for (const [word, value] of Object.entries(specialTens)) {
        if (str.includes(word)) {
          result += value;
          str = str.replace(word, '');
        }
      }

      // "ì‹­" ë‹¨ìœ„ ì²˜ë¦¬
      if (str.includes('ì‹­') || str.includes('ì—´')) {
        const tenIdx = str.indexOf('ì‹­') !== -1 ? str.indexOf('ì‹­') : str.indexOf('ì—´');
        const beforeTen = str.substring(0, tenIdx);
        const afterTen = str.substring(tenIdx + 1);
        
        let tens = 1;
        for (const [word, value] of Object.entries(koreanNumbers)) {
          if (beforeTen.includes(word) && value >= 1 && value <= 9) {
            tens = value;
            break;
          }
        }
        result += tens * 10;
        str = afterTen;
      }

      // ì¼ì˜ ìë¦¬ ì²˜ë¦¬
      for (const [word, value] of Object.entries(koreanNumbers)) {
        if (str.includes(word) && value >= 1 && value <= 9) {
          result += value;
          break;
        }
      }

      // ë‹¨ìˆœ í•œê¸€ ìˆ«ì (ì¼, ì´, ì‚¼... ë˜ëŠ” í•˜ë‚˜, ë‘˜, ì…‹...)
      if (result === 0) {
        for (const [word, value] of Object.entries(koreanNumbers)) {
          if (str.includes(word)) {
            return value;
          }
        }
      }

      return result > 0 ? result : null;
    }

    // Game State
    let gameState = 'ready';
    let currentQuestion = null;
    let score = 0;
    let totalQuestions = 0;
    let selectedDan = 0;
    let history = [];
    let recognition = null;
    let retryCount = 0;
    let micStream = null; // ë§ˆì´í¬ ìŠ¤íŠ¸ë¦¼ ìœ ì§€
    let isRecognitionActive = false;
    let waitingForAnswer = false;
    const synth = window.speechSynthesis;

    // DOM Elements
    const questionDisplay = document.getElementById('questionDisplay');
    const questionText = document.getElementById('questionText');
    const messageBox = document.getElementById('messageBox');
    const messageText = document.getElementById('messageText');
    const userAnswerBox = document.getElementById('userAnswerBox');
    const userAnswer = document.getElementById('userAnswer');
    const listeningIndicator = document.getElementById('listeningIndicator');
    const danSelection = document.getElementById('danSelection');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const restartBtn = document.getElementById('restartBtn');
    const retryBtn = document.getElementById('retryBtn');
    const scoreEl = document.getElementById('score');
    const currentQEl = document.getElementById('currentQ');
    const historyEl = document.getElementById('history');
    const historyList = document.getElementById('historyList');
    const danButtons = document.querySelectorAll('.dan-btn');
    const manualInput = document.getElementById('manualInput');
    const manualAnswer = document.getElementById('manualAnswer');
    const submitManual = document.getElementById('submitManual');
    const micStatus = document.getElementById('micStatus');

    // ë§ˆì´í¬ ê¶Œí•œ ìš”ì²­ ë° ìŠ¤íŠ¸ë¦¼ ìœ ì§€
    async function initMicrophone() {
      try {
        micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        micStatus.textContent = 'ğŸ¤ ë§ˆì´í¬ ì¤€ë¹„ ì™„ë£Œ';
        micStatus.className = 'mic-status show ready';
        initRecognition();
        return true;
      } catch (err) {
        console.error('ë§ˆì´í¬ ê¶Œí•œ ì˜¤ë¥˜:', err);
        micStatus.textContent = 'âŒ ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤';
        micStatus.className = 'mic-status show error';
        manualInput.classList.add('show');
        return false;
      }
    }

    // Initialize Speech Recognition (í•œ ë²ˆë§Œ)
    function initRecognition() {
      if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
        micStatus.textContent = 'âŒ ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„±ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤';
        micStatus.className = 'mic-status show error';
        return;
      }

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.lang = 'ko-KR';
      recognition.continuous = true; // ì—°ì† ì¸ì‹ ëª¨ë“œ
      recognition.interimResults = true;
      recognition.maxAlternatives = 3;

      recognition.onresult = (event) => {
        if (!waitingForAnswer) return;

        let finalTranscript = '';

        for (let i = event.resultIndex; i < event.results.length; i++) {
          const transcript = event.results[i][0].transcript;
          if (event.results[i].isFinal) {
            finalTranscript += transcript;
          }
        }

        // ìµœì¢… ê²°ê³¼ ì²˜ë¦¬
        if (finalTranscript && waitingForAnswer) {
          waitingForAnswer = false;
          listeningIndicator.classList.remove('show');
          processAnswer(finalTranscript);
        }
      };

      recognition.onerror = (event) => {
        console.log('Recognition error:', event.error);
        
        if (event.error === 'not-allowed') {
          micStatus.textContent = 'âŒ ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”';
          micStatus.className = 'mic-status show error';
          manualInput.classList.add('show');
        } else if (event.error === 'no-speech' && waitingForAnswer) {
          // ìŒì„±ì´ ì—†ìœ¼ë©´ ê³„ì† ëŒ€ê¸°
          handleNoSpeech();
        }
      };

      recognition.onend = () => {
        isRecognitionActive = false;
        // ê²Œì„ ì¤‘ì´ë©´ ìë™ìœ¼ë¡œ ë‹¤ì‹œ ì‹œì‘
        if (gameState === 'playing' || gameState === 'listening') {
          startRecognition();
        }
      };
    }

    // ìŒì„± ì¸ì‹ ì‹œì‘ (ê¶Œí•œ ìš”ì²­ ì—†ì´)
    function startRecognition() {
      if (!recognition || isRecognitionActive) return;
      
      try {
        recognition.start();
        isRecognitionActive = true;
      } catch (e) {
        console.log('Recognition already started');
      }
    }

    // ìŒì„± ì¸ì‹ ì¤‘ì§€
    function stopRecognition() {
      if (recognition && isRecognitionActive) {
        try {
          recognition.stop();
          isRecognitionActive = false;
        } catch (e) {
          console.log('Recognition stop error:', e);
        }
      }
    }

    // Speak function
    function speak(text, onEnd) {
      synth.cancel();
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'ko-KR';
      utterance.rate = 0.9;
      utterance.pitch = 1;
      if (onEnd) {
        utterance.onend = onEnd;
      }
      synth.speak(utterance);
    }

    // Generate question
    function generateQuestion() {
      const dan = selectedDan === 0 ? Math.floor(Math.random() * 8) + 2 : selectedDan;
      const num = Math.floor(Math.random() * 9) + 1;
      return { dan, num, answer: dan * num };
    }

    // Update UI
    function updateScore() {
      scoreEl.textContent = score;
      currentQEl.textContent = totalQuestions;
    }

    function setMessage(text, state = '') {
      messageText.textContent = text;
      messageBox.className = 'message-box' + (state ? ' ' + state : '');
    }

    // Start listening for answer
    function startListening() {
      listeningIndicator.classList.add('show');
      retryBtn.classList.add('hide');
      manualInput.classList.remove('show');
      gameState = 'listening';
      waitingForAnswer = true;

      // 5ì´ˆ í›„ íƒ€ì„ì•„ì›ƒ
      setTimeout(() => {
        if (waitingForAnswer) {
          handleNoSpeech();
        }
      }, 6000);
    }

    function processAnswer(transcript) {
      const answer = koreanToNumber(transcript);

      userAnswer.textContent = transcript + (answer !== null ? ` (${answer})` : '');
      userAnswerBox.classList.add('show');

      if (answer !== null) {
        checkAnswer(answer);
      } else {
        handleNoSpeech();
      }
    }

    function handleNoSpeech() {
      waitingForAnswer = false;
      listeningIndicator.classList.remove('show');
      retryCount++;
      
      if (retryCount >= 3) {
        setMessage('ìŒì„± ì¸ì‹ì´ ì–´ë ¤ì›Œìš”. ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”!');
        manualInput.classList.add('show');
        retryBtn.classList.remove('hide');
      } else {
        setMessage('ì˜ ëª» ë“¤ì—ˆì–´ìš”. ë‹¤ì‹œ ë§í•´ì£¼ì„¸ìš”!');
        retryBtn.classList.remove('hide');
        speak('ë‹¤ì‹œ í•œë²ˆ ë§í•´ì£¼ì„¸ìš”!');
      }
    }

    // Check answer
    function checkAnswer(answer) {
      if (!currentQuestion) return;

      retryCount = 0;
      retryBtn.classList.add('hide');
      manualInput.classList.remove('show');

      const isCorrect = answer === currentQuestion.answer;

      history.push({
        question: `${currentQuestion.dan} Ã— ${currentQuestion.num}`,
        correctAnswer: currentQuestion.answer,
        userAnswer: answer,
        isCorrect
      });

      if (isCorrect) {
        score++;
        updateScore();
        gameState = 'correct';
        setMessage('ì •ë‹µì´ì—ìš”! ğŸ‰', 'correct');
        speak('ë”©ë™ëŒ•! ì •ë‹µì´ì—ìš”!', () => {
          setTimeout(nextQuestion, 1000);
        });
      } else {
        gameState = 'wrong';
        setMessage(`í‹€ë ¸ì–´ìš”! ì •ë‹µì€ ${currentQuestion.answer}ì´ì—ìš”`, 'wrong');
        speak(`ë•¡! í‹€ë ¸ì–´ìš”. ì •ë‹µì€ ${currentQuestion.answer}ì…ë‹ˆë‹¤.`, () => {
          setTimeout(nextQuestion, 1500);
        });
      }
    }

    // Next question
    function nextQuestion() {
      if (totalQuestions >= 10) {
        finishGame();
        return;
      }

      retryCount = 0;
      currentQuestion = generateQuestion();
      totalQuestions++;
      updateScore();
      userAnswerBox.classList.remove('show');
      manualInput.classList.remove('show');
      gameState = 'playing';

      questionText.textContent = `${currentQuestion.dan} Ã— ${currentQuestion.num}`;
      questionDisplay.classList.add('show');

      const questionSpeech = `${currentQuestion.dan} ê³±í•˜ê¸° ${currentQuestion.num}ì€?`;
      setMessage(questionSpeech);

      speak(questionSpeech, () => {
        setTimeout(startListening, 500);
      });
    }

    // Finish game
    function finishGame() {
      gameState = 'finished';
      waitingForAnswer = false;
      stopRecognition();
      
      questionDisplay.classList.remove('show');
      manualInput.classList.remove('show');
      retryBtn.classList.add('hide');
      listeningIndicator.classList.remove('show');
      setMessage(`ê²Œì„ ë! ${score}ì ì„ ë°›ì•˜ì–´ìš”!`);
      speak(`ê²Œì„ì´ ëë‚¬ìŠµë‹ˆë‹¤. ì—´ ë¬¸ì œ ì¤‘ ${score}ê°œë¥¼ ë§í˜”ì–´ìš”!`);

      startBtn.classList.add('hide');
      stopBtn.classList.add('hide');
      restartBtn.classList.remove('hide');
      danSelection.classList.remove('hide');

      // Show history
      historyList.innerHTML = '';
      history.forEach(item => {
        const div = document.createElement('div');
        div.className = 'history-item ' + (item.isCorrect ? 'correct' : 'wrong');
        div.innerHTML = `
          <span class="history-question">${item.question} = ${item.correctAnswer}</span>
          <span class="history-result ${item.isCorrect ? 'correct' : 'wrong'}">
            ${item.isCorrect ? 'â­•' : `âŒ (${item.userAnswer})`}
          </span>
        `;
        historyList.appendChild(div);
      });
      historyEl.classList.add('show');
    }

    // Start game
    async function startGame() {
      // ì²˜ìŒ ì‹œì‘ì‹œ ë§ˆì´í¬ ê¶Œí•œ ìš”ì²­
      if (!micStream) {
        const hasPermission = await initMicrophone();
        if (!hasPermission) {
          // ê¶Œí•œ ì—†ì–´ë„ ìˆ˜ë™ ì…ë ¥ìœ¼ë¡œ ê²Œì„ ê°€ëŠ¥
        }
      }

      score = 0;
      totalQuestions = 0;
      history = [];
      retryCount = 0;
      updateScore();
      historyEl.classList.remove('show');
      userAnswerBox.classList.remove('show');
      manualInput.classList.remove('show');

      startBtn.classList.add('hide');
      restartBtn.classList.add('hide');
      stopBtn.classList.remove('hide');
      danSelection.classList.add('hide');

      gameState = 'playing';
      
      // ìŒì„± ì¸ì‹ ì‹œì‘
      startRecognition();
      
      speak('êµ¬êµ¬ë‹¨ ê²Œì„ì„ ì‹œì‘í•©ë‹ˆë‹¤!', () => {
        setTimeout(nextQuestion, 500);
      });
    }

    // Reset game
    function resetGame() {
      synth.cancel();
      waitingForAnswer = false;
      stopRecognition();

      gameState = 'ready';
      currentQuestion = null;
      score = 0;
      totalQuestions = 0;
      history = [];
      retryCount = 0;
      updateScore();

      questionDisplay.classList.remove('show');
      userAnswerBox.classList.remove('show');
      listeningIndicator.classList.remove('show');
      historyEl.classList.remove('show');
      manualInput.classList.remove('show');
      setMessage('ì‹œì‘ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”!');

      startBtn.classList.remove('hide');
      stopBtn.classList.add('hide');
      restartBtn.classList.add('hide');
      retryBtn.classList.add('hide');
      danSelection.classList.remove('hide');
    }

    // Event listeners
    startBtn.addEventListener('click', startGame);
    stopBtn.addEventListener('click', resetGame);
    restartBtn.addEventListener('click', startGame);
    
    retryBtn.addEventListener('click', () => {
      retryCount = 0;
      manualInput.classList.remove('show');
      startListening();
    });

    submitManual.addEventListener('click', () => {
      const value = parseInt(manualAnswer.value);
      if (!isNaN(value)) {
        manualAnswer.value = '';
        userAnswer.textContent = value;
        userAnswerBox.classList.add('show');
        waitingForAnswer = false;
        listeningIndicator.classList.remove('show');
        checkAnswer(value);
      }
    });

    manualAnswer.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        submitManual.click();
      }
    });

    danButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        danButtons.forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        selectedDan = parseInt(btn.dataset.dan);
      });
    });
  </script>
</body>
</html>
